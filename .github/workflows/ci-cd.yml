name: CI/CD Pipeline

# ============================================================================
# Trigger Configuration
# ============================================================================
on:
  push:
    branches: [main, develop, development]
    tags: ['v*']  # Trigger on version tags
  pull_request:
    branches: [main, develop, development]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests (for emergency deployments)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      skip_docker_publish:
        description: 'Skip Docker publishing'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      docker_tag_suffix:
        description: 'Additional Docker tag suffix (optional)'
        required: false
        type: string
        default: ''

# ============================================================================
# Permissions
# ============================================================================
permissions:
  contents: write
  packages: write
  security-events: write

# ============================================================================
# Environment Variables
# ============================================================================
env:
  NODE_VERSION: '20'
  DOCKER_IMAGE_NAME: agigante80/actual-mcp-server
  DOCKER_PLATFORMS: 'linux/amd64,linux/arm64'
  REGISTRY: docker.io

# ============================================================================
# Jobs
# ============================================================================
jobs:
  # --------------------------------------------------------------------------
  # Job 1: Version Generation
  # --------------------------------------------------------------------------
  version:
    name: Version Generation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      version: ${{ steps.version.outputs.version }}
      docker_version: ${{ steps.version.outputs.docker_version }}
      is_release: ${{ steps.version.outputs.is_release }}
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ“ Extract version
        id: version
        run: |
          BASE_VERSION=$(cat VERSION | tr -d '\n')
          SHORT_SHA=$(git rev-parse --short HEAD)
          
          # Add development metadata for non-main branches
          if [[ "${{ github.ref }}" == "refs/heads/develop" ]] || [[ "${{ github.ref }}" == "refs/heads/development" ]]; then
            VERSION="${BASE_VERSION}-dev-${SHORT_SHA}"
            echo "ðŸ”¨ This is a development build"
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            VERSION="${BASE_VERSION}"
            echo "ðŸš€ This is a stable release from main"
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${BASE_VERSION}"
            echo "ðŸ·ï¸ This is a tagged release"
          else
            # Feature branches or other branches
            BRANCH_NAME=$(echo "${{ github.ref_name }}" | sed 's/[^a-zA-Z0-9]/-/g')
            VERSION="${BASE_VERSION}-${BRANCH_NAME}-${SHORT_SHA}"
            echo "ðŸŒ¿ This is a feature branch build"
          fi
          
          # Docker doesn't allow + in tags, replace with -
          DOCKER_VERSION="${VERSION//+/-}"
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "docker_version=$DOCKER_VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Semver version: $VERSION"
          echo "ðŸ³ Docker version: $DOCKER_VERSION"
          
          # Determine if this is a stable release (no pre-release metadata)
          if [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "is_release=true" >> $GITHUB_OUTPUT
          else
            echo "is_release=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“Š Display version info
        run: |
          echo "### ðŸ“¦ Version Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Semver**: \`${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker**: \`${{ steps.version.outputs.docker_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Release**: ${{ steps.version.outputs.is_release }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY

  # --------------------------------------------------------------------------
  # Job 2: Lint & Type Check
  # --------------------------------------------------------------------------
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: version
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ” TypeScript type check
        run: npm run build

      - name: ðŸ“Š Check tool coverage
        run: npm run check:coverage

      - name: ðŸ“‹ Lint summary
        if: always()
        run: |
          echo "### âœ… Lint Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: \`${{ needs.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY

  # --------------------------------------------------------------------------
  # Job 3: Run Tests
  # --------------------------------------------------------------------------
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: version
    if: ${{ github.event.inputs.skip_tests != 'true' }}
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ—ï¸ Build project
        run: npm run build

      - name: ðŸ” Run npm audit
        run: |
          echo "Running npm audit..."
          npm audit --audit-level=high || echo "âš ï¸ Vulnerabilities found, but continuing..."

      - name: ðŸ§ª Run unit smoke tests
        env:
          # Dummy credentials for smoke tests (don't connect to actual server)
          ACTUAL_SERVER_URL: http://localhost:5006
          ACTUAL_PASSWORD: dummy-password-for-tests
          ACTUAL_BUDGET_SYNC_ID: 00000000-0000-0000-0000-000000000000
        run: node tests/unit/generated_tools.smoke.test.js

      - name: ðŸ“‹ Test summary
        if: always()
        run: |
          echo "### ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: \`${{ needs.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY

  # --------------------------------------------------------------------------
  # Job 3.5: Docker E2E Tests
  # --------------------------------------------------------------------------
  docker-e2e:
    name: Docker E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: version
    if: ${{ github.event.inputs.skip_tests != 'true' }}
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸŽ­ Install Playwright
        run: npx playwright install --with-deps

      - name: ðŸ§ª Run Docker E2E tests
        run: npm run test:e2e:docker

      - name: ðŸ“¸ Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

      - name: ðŸ§¹ Cleanup Docker containers
        if: always()
        run: docker compose -f docker-compose.test.yaml down -v

      - name: ðŸ“‹ Docker E2E summary
        if: always()
        run: |
          echo "### ðŸ³ Docker E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: \`${{ needs.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY

  # --------------------------------------------------------------------------
  # Job 4: Build Application
  # --------------------------------------------------------------------------
  build:
    name: Build Application
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [version, lint, test, docker-e2e]
    if: |
      always() &&
      needs.version.result == 'success' &&
      needs.lint.result == 'success' &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (needs.docker-e2e.result == 'success' || needs.docker-e2e.result == 'skipped')
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci --omit=dev

      - name: âœ… Verify build artifacts
        run: |
          echo "âœ… Node.js dependencies installed"
          echo "âœ… Application ready for deployment"

      - name: ðŸ“‹ Build summary
        run: |
          echo "### ðŸ—ï¸ Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: \`${{ needs.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY

  # --------------------------------------------------------------------------
  # Job 5: Validate Docker Hub Description
  # --------------------------------------------------------------------------
  validate-short-description:
    name: Validate Docker Description
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: version
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: âœ… Validate short description length
        run: |
          chmod +x ./docker/validate-docker-desc.sh
          ./docker/validate-docker-desc.sh
          echo "âœ… Docker Hub short description is valid (<= 100 characters)"

      - name: ðŸ“‹ Validation summary
        if: always()
        run: |
          CHAR_COUNT=$(wc -c < docker/description/short.md | tr -d ' ')
          echo "### ðŸ“ Docker Description Validation" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Character Count**: $CHAR_COUNT / 100" >> $GITHUB_STEP_SUMMARY
          echo "- **Remaining**: $((100 - CHAR_COUNT))" >> $GITHUB_STEP_SUMMARY

  # --------------------------------------------------------------------------
  # Job 6: Docker Test Build
  # --------------------------------------------------------------------------
  docker-test:
    name: Docker Test Build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [version, build, validate-short-description]
    if: |
      always() &&
      needs.version.result == 'success' &&
      needs.build.result == 'success' &&
      needs.validate-short-description.result == 'success'
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ§ª Test Docker build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          load: true
          tags: ${{ env.DOCKER_IMAGE_NAME }}:test
          build-args: |
            VERSION=${{ needs.version.outputs.version }}

      - name: âœ… Test container startup (validates it starts)
        run: |
          # Create minimal test config
          mkdir -p test-config
          echo '{}' > test-config/config.json
          
          docker run --rm -d --name test-container \
            -v $(pwd)/test-config:/app/config:ro \
            -e VERSION=${{ needs.version.outputs.version }} \
            ${{ env.DOCKER_IMAGE_NAME }}:test
          
          # Give container a moment to start
          sleep 5
          
          # Check if container started and show logs
          echo "Container logs:"
          docker logs test-container 2>&1 | head -n 20 || true
          
          # Check if the application logged the version
          if docker logs test-container 2>&1 | grep -q "Starting Actual"; then
            echo "âœ… Container started successfully"
            docker stop test-container 2>/dev/null || true
          else
            echo "âš ï¸  Container started but may have validation issues (expected without full config)"
            docker stop test-container 2>/dev/null || true
          fi
          
          # Clean up
          rm -rf test-config

      - name: ðŸ“‹ Docker test summary
        if: always()
        run: |
          echo "### ðŸ³ Docker Test Build" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: \`${{ needs.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: \`${{ env.DOCKER_IMAGE_NAME }}:test\`" >> $GITHUB_STEP_SUMMARY

  # --------------------------------------------------------------------------
  # Job 7: Docker Build and Publish (Consolidated)
  # --------------------------------------------------------------------------
  docker-publish:
    name: Build & Publish Docker Images
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [version, docker-test]
    if: |
      always() &&
      needs.version.result == 'success' &&
      needs.docker-test.result == 'success' &&
      github.event.inputs.skip_docker_publish != 'true' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' ||
       github.ref == 'refs/heads/development' || startsWith(github.ref, 'refs/tags/'))
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ³ Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ” Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ðŸ” Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ·ï¸ Generate Docker tags
        id: meta
        run: |
          DOCKER_VERSION="${{ needs.version.outputs.docker_version }}"
          DOCKER_HUB_IMAGE="${{ env.DOCKER_IMAGE_NAME }}"
          # Extract just the repository name (after /) for GHCR
          REPO_NAME="${DOCKER_HUB_IMAGE##*/}"
          GHCR_IMAGE="ghcr.io/${{ github.repository_owner }}/${REPO_NAME}"
          
          # Base tags (using Docker-safe version)
          TAGS="${DOCKER_HUB_IMAGE}:${DOCKER_VERSION},${GHCR_IMAGE}:${DOCKER_VERSION}"
          
          # Add branch-specific tags
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            TAGS="${TAGS},${DOCKER_HUB_IMAGE}:main,${GHCR_IMAGE}:main"
            TAGS="${TAGS},${DOCKER_HUB_IMAGE}:latest,${GHCR_IMAGE}:latest"
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            TAGS="${TAGS},${DOCKER_HUB_IMAGE}:develop,${GHCR_IMAGE}:develop"
            TAGS="${TAGS},${DOCKER_HUB_IMAGE}:development,${GHCR_IMAGE}:development"
          elif [[ "${{ github.ref }}" == "refs/heads/development" ]]; then
            TAGS="${TAGS},${DOCKER_HUB_IMAGE}:development,${GHCR_IMAGE}:development"
          fi
          
          # Add latest tag ONLY for tagged releases (e.g., v1.0.0)
          # NOT for branch builds, even if version is clean semver
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            TAGS="${TAGS},${DOCKER_HUB_IMAGE}:latest,${GHCR_IMAGE}:latest"
          fi
          
          # Add custom suffix if provided
          if [[ -n "${{ github.event.inputs.docker_tag_suffix }}" ]]; then
            SUFFIX="${{ github.event.inputs.docker_tag_suffix }}"
            TAGS="${TAGS},${DOCKER_HUB_IMAGE}:${DOCKER_VERSION}-${SUFFIX},${GHCR_IMAGE}:${DOCKER_VERSION}-${SUFFIX}"
          fi
          
          echo "tags=${TAGS}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Docker tags: ${TAGS}"

      - name: ðŸ—ï¸ Build and push Docker images
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: ${{ env.DOCKER_PLATFORMS }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          build-args: |
            VERSION=${{ needs.version.outputs.version }}
          cache-from: |
            type=gha,scope=${{ github.ref_name }}
            type=gha,scope=develop
            type=gha,scope=main
          cache-to: type=gha,mode=max,scope=${{ github.ref_name }}
          labels: |
            org.opencontainers.image.version=${{ needs.version.outputs.version }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.source=${{ github.repositoryUrl }}

      - name: ðŸ“‹ Docker publish summary
        run: |
          echo "### ðŸ³ Docker Images Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: \`${{ needs.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Platforms**: \`${{ env.DOCKER_PLATFORMS }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Tags**:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" | tr ',' '\n' >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # --------------------------------------------------------------------------
  # Job 8: Security Scanning
  # --------------------------------------------------------------------------
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [version, docker-test]
    if: |
      always() &&
      needs.version.result == 'success' &&
      needs.docker-test.result == 'success'
    permissions:
      contents: read
      security-events: write
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ—ï¸ Build image for scanning
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          load: true
          tags: ${{ env.DOCKER_IMAGE_NAME }}:scan
          build-args: |
            VERSION=${{ needs.version.outputs.version }}

      - name: ðŸ” Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.DOCKER_IMAGE_NAME }}:scan
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: ðŸ“¤ Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        continue-on-error: true
        with:
          sarif_file: 'trivy-results.sarif'

      - name: ðŸ“‹ Security scan summary
        if: always()
        run: |
          echo "### ðŸ”’ Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Scanner**: Trivy" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: \`${{ env.DOCKER_IMAGE_NAME }}:scan\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š Full results available in the Security tab" >> $GITHUB_STEP_SUMMARY

  # --------------------------------------------------------------------------
  # Job 9: Update Docker Hub Description
  # --------------------------------------------------------------------------
  docker-hub-description:
    name: Update Docker Hub Description
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [version, docker-publish]
    if: |
      (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')) &&
      needs.docker-publish.result == 'success'
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ“ Read Docker descriptions
        id: get-desc
        run: |
          SHORT_DESC=$(cat docker/description/short.md)
          echo "short=${SHORT_DESC}" >> $GITHUB_OUTPUT
          echo "Short description: ${SHORT_DESC}"

      - name: ðŸ³ Update Docker Hub description
        uses: peter-evans/dockerhub-description@v4
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          repository: ${{ env.DOCKER_IMAGE_NAME }}
          short-description: ${{ steps.get-desc.outputs.short }}
          readme-filepath: ./docker/description/long.md

      - name: ðŸ“‹ Docker Hub update summary
        run: |
          echo "### ðŸ³ Docker Hub Description Updated" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: \`${{ env.DOCKER_IMAGE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Short Description**: ${{ steps.get-desc.outputs.short }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Long Description**: Updated from docker/description/long.md" >> $GITHUB_STEP_SUMMARY

  # --------------------------------------------------------------------------
  # Job 10: Deployment Test
  # --------------------------------------------------------------------------
  deployment-test:
    name: Deployment Test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [version, docker-publish]
    if: |
      always() &&
      needs.version.result == 'success' &&
      needs.docker-publish.result == 'success'
    steps:
      - name: ðŸ§ª Test Docker Hub image
        run: |
          echo "Pulling image from Docker Hub..."
          docker pull ${{ env.DOCKER_IMAGE_NAME }}:${{ needs.version.outputs.docker_version }}
          
          echo "Testing image..."
          docker run --rm \
            -e VERSION=${{ needs.version.outputs.version }} \
            ${{ env.DOCKER_IMAGE_NAME }}:${{ needs.version.outputs.docker_version }} \
            node --version
          
          echo "âœ… Docker Hub image is working"

      - name: ðŸ§ª Test GHCR image
        run: |
          echo "Pulling image from GHCR..."
          # Extract repo name without Docker Hub username prefix
          REPO_NAME="${{ env.DOCKER_IMAGE_NAME }}"
          REPO_NAME="${REPO_NAME##*/}"
          docker pull ghcr.io/${{ github.repository_owner }}/${REPO_NAME}:${{ needs.version.outputs.docker_version }}
          
          echo "Testing image..."
          docker run --rm \
            -e VERSION=${{ needs.version.outputs.version }} \
            ghcr.io/${{ github.repository_owner }}/${REPO_NAME}:${{ needs.version.outputs.docker_version }} \
            node --version
          
          echo "âœ… GHCR image is working"

      - name: ðŸ“‹ Deployment test summary
        run: |
          echo "### âœ… Deployment Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Hub**: âœ… Passed" >> $GITHUB_STEP_SUMMARY
          echo "- **GHCR**: âœ… Passed" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: \`${{ needs.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY

  # --------------------------------------------------------------------------
  # Job 11: Create GitHub Release
  # --------------------------------------------------------------------------
  release:
    name: Create Release
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [version, docker-publish, security-scan]
    if: |
      always() &&
      needs.version.outputs.is_release == 'true' &&
      needs.docker-publish.result == 'success' &&
      (needs.security-scan.result == 'success' || needs.security-scan.result == 'skipped')
    permissions:
      contents: write
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“ Generate changelog
        id: changelog
        run: |
          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -n "$PREV_TAG" ]; then
            echo "Generating changelog from $PREV_TAG to ${{ needs.version.outputs.version }}"
            CHANGELOG=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          else
            echo "No previous tag found, showing recent commits"
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges -n 20)
          fi
          
          # Save changelog to file
          echo "$CHANGELOG" > changelog.txt
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ðŸŽ‰ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.version.outputs.version }}
          name: Release v${{ needs.version.outputs.version }}
          body: |
            ## ðŸŽ‰ Release v${{ needs.version.outputs.version }}
            
            ### ðŸ“¦ Docker Images
            
            ```bash
            # Docker Hub
            docker pull ${{ env.DOCKER_IMAGE_NAME }}:${{ needs.version.outputs.docker_version }}
            
            # GitHub Container Registry
            docker pull ghcr.io/${{ github.repository_owner }}/actual-mcp-server:${{ needs.version.outputs.docker_version }}
            ```
            
            ### ðŸ“ Changelog
            
            ${{ steps.changelog.outputs.changelog }}
            
            ### ðŸ”’ Security
            
            This release has been scanned for vulnerabilities. Check the Security tab for details.
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“‹ Release summary
        run: |
          echo "### ðŸŽ‰ Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: \`${{ needs.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: \`v${{ needs.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: Published" >> $GITHUB_STEP_SUMMARY

  # --------------------------------------------------------------------------
  # Final Summary
  # --------------------------------------------------------------------------
  summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [version, lint, test, docker-e2e, build, validate-short-description, docker-test,
            docker-publish, security-scan, deployment-test, release]
    if: always()
    steps:
      - name: ðŸ“Š Generate pipeline summary
        run: |
          echo "## ðŸš€ CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version Generation | ${{ needs.version.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker E2E | ${{ needs.docker-e2e.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Validate Description | ${{ needs.validate-short-description.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Test | ${{ needs.docker-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Publish | ${{ needs.docker-publish.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployment Test | ${{ needs.deployment-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Release | ${{ needs.release.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: \`${{ needs.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY

# ============================================================================
# Required Secrets:
# - DOCKERHUB_USER: Docker Hub username
# - DOCKERHUB_TOKEN: Docker Hub access token
# - GITHUB_TOKEN: Automatically provided by GitHub Actions
# ============================================================================

