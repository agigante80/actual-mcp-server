name: CI/CD Pipeline

# ============================================================================
# Trigger Configuration
# ============================================================================
# Runs on all pushes to main/develop, pull requests, and manual triggers
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip test jobs (for faster builds)'
        required: false
        type: boolean
        default: false
      skip_docker:
        description: 'Skip Docker build and push'
        required: false
        type: boolean
        default: false
      force_release:
        description: 'Force release creation (even on non-main branch)'
        required: false
        type: boolean
        default: false

# ============================================================================
# Permissions
# ============================================================================
# Required for creating releases and publishing packages
permissions:
  contents: write
  packages: write

# ============================================================================
# Environment Variables
# ============================================================================
env:
  NODE_VERSION: '20'
  DOCKER_IMAGE_NAME: agigante80/actual-mcp-server
  REGISTRY: docker.io

# ============================================================================
# Jobs
# ============================================================================
jobs:
  # --------------------------------------------------------------------------
  # Job 1: Lint & Static Analysis
  # --------------------------------------------------------------------------
  # Runs code quality checks and TypeScript compilation
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ” TypeScript type check
        run: npm run build

      - name: ðŸ“Š Check tool coverage
        run: npm run check:coverage

      - name: ðŸ” Run npm audit (non-blocking)
        run: npm audit --audit-level=high || true
        continue-on-error: true

  # --------------------------------------------------------------------------
  # Job 2: Unit & Integration Tests
  # --------------------------------------------------------------------------
  # Runs all test suites (depends on lint passing)
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    needs: lint
    if: ${{ !inputs.skip_tests }}
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ—ï¸ Build project
        run: npm run build

      - name: ðŸ§ª Run unit smoke tests
        run: node tests/unit/generated_tools.smoke.test.js

      - name: ðŸ“Š Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results/
          retention-days: 30

  # --------------------------------------------------------------------------
  # Job 3: End-to-End Tests
  # --------------------------------------------------------------------------
  # Runs Playwright E2E tests (depends on lint passing, runs parallel with test)
  # NOTE: E2E tests require Actual Budget server infrastructure - skipped in CI
  e2e:
    name: E2E Tests (Playwright)
    runs-on: ubuntu-latest
    needs: lint
    if: false  # Skip E2E tests in CI (require Actual Budget server + env vars)
    continue-on-error: true
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ—ï¸ Build project
        run: npm run build

      - name: ðŸŽ­ Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: ðŸ§ª Run Playwright E2E tests
        run: npm run test:e2e

      - name: ðŸ“Š Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

  # --------------------------------------------------------------------------
  # Job 4: Build Artifacts
  # --------------------------------------------------------------------------
  # Creates production build and prepares for Docker (depends on tests passing)
  build:
    name: Build Artifacts
    runs-on: ubuntu-latest
    needs: [test]
    # Only run if unit tests passed OR if tests were skipped via manual trigger
    if: ${{ !failure() && !cancelled() || inputs.skip_tests }}
    outputs:
      version: ${{ steps.version.outputs.version }}
      short_sha: ${{ steps.sha.outputs.short_sha }}
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for version bumping

      - name: ðŸ”§ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ—ï¸ Build production artifacts
        run: npm run build

      - name: ðŸ“ Generate version info
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Version: $VERSION"

      - name: ðŸ”– Get commit SHA
        id: sha
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "ðŸ”– Commit: $SHORT_SHA"

      - name: ðŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 7

  # --------------------------------------------------------------------------
  # Job 5: Docker Build & Publish
  # --------------------------------------------------------------------------
  # Builds and pushes Docker image (depends on build passing, only on push or manual)
  docker:
    name: Docker Build & Push
    runs-on: ubuntu-latest
    needs: build
    if: ${{ !inputs.skip_docker && (github.event_name == 'push' || github.event_name == 'workflow_dispatch') }}
    outputs:
      docker_tag: ${{ steps.meta.outputs.tags }}
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ” Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ðŸ·ï¸ Generate Docker tags and labels
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_IMAGE_NAME }}
          tags: |
            # Tag with commit SHA for main branch
            type=raw,value=latest-${{ needs.build.outputs.short_sha }},enable=${{ github.ref == 'refs/heads/main' }}
            # Tag with 'latest' on main
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
            # Tag with commit SHA for develop branch
            type=raw,value=development-${{ needs.build.outputs.short_sha }},enable=${{ github.ref == 'refs/heads/develop' }}
            # Tag with 'development' on develop
            type=raw,value=development,enable=${{ github.ref == 'refs/heads/develop' }}
          labels: |
            org.opencontainers.image.title=Actual MCP Server
            org.opencontainers.image.description=MCP bridge for Actual Finance
            org.opencontainers.image.version=${{ needs.build.outputs.version }}
            org.opencontainers.image.revision=${{ github.sha }}

      - name: ðŸ” Scan for vulnerabilities (pre-build)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'  # Non-blocking
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: ðŸ—ï¸ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # Only AMD64 for CI (ARM64 causes timeouts - use multi-platform only for releases)
          platforms: linux/amd64

      - name: ðŸ” Scan Docker image for vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.DOCKER_IMAGE_NAME }}:latest-${{ needs.build.outputs.short_sha }}
          format: 'sarif'
          output: 'trivy-image-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'  # Non-blocking
        if: github.ref == 'refs/heads/main'

      - name: ðŸ“Š Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # --------------------------------------------------------------------------
  # Job 6: Release & Docker Hub Update
  # --------------------------------------------------------------------------
  # Creates GitHub release and updates Docker Hub descriptions (only on main or forced)
  release:
    name: Release & Update Docker Hub
    runs-on: ubuntu-latest
    needs: [build, docker]
    if: ${{ (github.ref == 'refs/heads/main' && github.event_name == 'push') || (github.event_name == 'workflow_dispatch' && inputs.force_release) }}
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”§ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“ Get latest tag
        id: get_tag
        run: |
          # Get the latest tag or default to v0.0.0
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ Latest tag: $LATEST_TAG"

      - name: ðŸ”¢ Bump version (patch)
        id: bump_version
        run: |
          LATEST_TAG="${{ steps.get_tag.outputs.latest_tag }}"
          # Remove 'v' prefix and split version
          VERSION="${LATEST_TAG#v}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          
          # Bump patch version
          PATCH=$((PATCH + 1))
          NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ†• New version: $NEW_VERSION"

      - name: ðŸ“‹ Generate changelog
        id: changelog
        run: |
          LATEST_TAG="${{ steps.get_tag.outputs.latest_tag }}"
          
          # Generate changelog from commits since last tag
          CHANGELOG=$(git log ${LATEST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges | head -20)
          
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="- Initial release"
          fi
          
          # Save to file for multiline output
          echo "$CHANGELOG" > changelog.txt
          echo "ðŸ“ Generated changelog with $(echo "$CHANGELOG" | wc -l) entries"

      - name: ðŸ·ï¸ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.bump_version.outputs.new_version }}
          name: Release ${{ steps.bump_version.outputs.new_version }}
          body: |
            ## ðŸš€ Release ${{ steps.bump_version.outputs.new_version }}
            
            ### ðŸ“¦ Docker Images
            - `${{ env.DOCKER_IMAGE_NAME }}:latest`
            - `${{ env.DOCKER_IMAGE_NAME }}:latest-${{ needs.build.outputs.short_sha }}`
            
            ### ðŸ“ Changes
            ${{ steps.changelog.outputs.changelog }}
            
            ### ðŸ”— Links
            - [Docker Hub](https://hub.docker.com/r/${{ env.DOCKER_IMAGE_NAME }})
            - [GitHub Repository](https://github.com/${{ github.repository }})
            - [Documentation](https://github.com/${{ github.repository }}/blob/main/README.md)
            
            ### ðŸ“Š Coverage
            - **37 tools** implemented (76% API coverage)
            - Full TypeScript implementation
            - Production-ready with retry logic and observability
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“ Ensure GitHub link in Docker Hub description
        run: |
          LONG_DESC=$(cat docker/description/long.md)
          REPO_URL="https://github.com/${{ github.repository }}"
          
          if ! grep -q "$REPO_URL" docker/description/long.md; then
            echo -e "\n\n## ðŸ”— GitHub Repository\n\n$REPO_URL" >> docker/description/long.md
            echo "âœ… Added GitHub repository link to description"
          else
            echo "âœ… GitHub repository link already present"
          fi

      - name: ðŸ³ Update Docker Hub description via API
        run: |
          # Get Docker Hub token
          TOKEN=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d '{"username": "${{ secrets.DOCKERHUB_USER }}", "password": "${{ secrets.DOCKERHUB_TOKEN }}"}' \
            https://hub.docker.com/v2/users/login/ | jq -r .token)
          
          if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
            echo "âš ï¸  Failed to get Docker Hub token, skipping description update"
            exit 0
          fi
          
          # Read descriptions
          SHORT_DESC=$(cat docker/description/short.md)
          FULL_DESC=$(cat docker/description/long.md)
          
          # Update repository description
          RESPONSE=$(curl -s -X PATCH \
            -H "Authorization: JWT ${TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"description\": \"${SHORT_DESC}\", \"full_description\": \"${FULL_DESC}\"}" \
            "https://hub.docker.com/v2/repositories/${{ env.DOCKER_IMAGE_NAME }}/")
          
          if echo "$RESPONSE" | jq -e .name > /dev/null 2>&1; then
            echo "âœ… Docker Hub description updated successfully"
          else
            echo "âš ï¸  Failed to update Docker Hub description: $RESPONSE"
            exit 0
          fi
        continue-on-error: true

  # --------------------------------------------------------------------------
  # Job 7: Summary Report
  # --------------------------------------------------------------------------
  # Generates pipeline summary (runs after all jobs)
  summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [build, docker, release]
    if: ${{ always() && !cancelled() && ((github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch') }}
    steps:
      - name: ðŸ“Š Generate summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## âœ… CI/CD Pipeline Results
          
          ### ðŸ—ï¸ Build Information
          - **Trigger:** ${{ github.event_name }}
          - **Version:** ${{ needs.build.outputs.version }}
          - **Commit:** ${{ needs.build.outputs.short_sha }}
          - **Branch:** ${{ github.ref_name }}
          
          ### ðŸ³ Docker Images
          - \`${{ env.DOCKER_IMAGE_NAME }}:latest\`
          - \`${{ env.DOCKER_IMAGE_NAME }}:latest-${{ needs.build.outputs.short_sha }}\`
          
          ### ðŸ·ï¸ GitHub Release
          - **Tag:** Created/updated release
          - **Changelog:** Generated from recent commits
          
          ### ðŸ”— Links
          - [Docker Hub](https://hub.docker.com/r/${{ env.DOCKER_IMAGE_NAME }})
          - [GitHub Repository](https://github.com/${{ github.repository }})
          - [Latest Release](https://github.com/${{ github.repository }}/releases/latest)
          
          ### ðŸ“Š Coverage
          - **37 tools** implemented (76% of Actual Budget API)
          - Full TypeScript implementation
          - Production-ready with security scanning
          
          ---
          
          **Pipeline Status:** All checks passed âœ…
          EOF

# ============================================================================
# Additional Notes
# ============================================================================
# 
# Security Features:
# - Trivy vulnerability scanning for both filesystem and Docker images
# - npm audit for dependency vulnerabilities
# - Non-root Docker container execution
# - Secrets managed via GitHub Secrets
# 
# Performance Optimizations:
# - Parallel execution of test and e2e jobs
# - Docker layer caching via GitHub Actions cache
# - npm dependency caching
# - Multi-platform Docker builds (amd64, arm64)
# 
# Maintenance:
# - Automatic version bumping (patch level)
# - Changelog generation from git commits
# - Docker Hub description auto-update
# - Test results archived for 30 days
# 
# Required Secrets:
# - DOCKERHUB_USER: Docker Hub username
# - DOCKERHUB_TOKEN: Docker Hub access token (for login, push, and API operations)
# - GITHUB_TOKEN: Automatically provided by GitHub Actions
#
# Note: DOCKERHUB_TOKEN is used for all Docker Hub operations including:
# - Docker login and image push (via docker/login-action)
# - Docker Hub API calls for description updates (via direct API)
# Description updates are non-blocking and will be skipped if authentication fails.
# 
# ============================================================================
