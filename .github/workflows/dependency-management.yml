name: Dependency Management

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
  pull_request:
    paths:
      - 'package.json'
      - 'package-lock.json'

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  audit-security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Run npm audit
        run: |
          npm audit --audit-level=moderate || true
          npm audit --json > audit-report.json || true
      
      - name: Check for critical vulnerabilities
        id: critical-check
        run: |
          CRITICAL=$(jq '.metadata.vulnerabilities.critical' audit-report.json)
          HIGH=$(jq '.metadata.vulnerabilities.high' audit-report.json)
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          
          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "âš ï¸ Found $CRITICAL critical and $HIGH high severity vulnerabilities"
            exit 1
          fi
      
      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-report
          path: audit-report.json
          retention-days: 30
  
  check-outdated:
    name: Check Outdated Packages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Check for outdated packages
        run: |
          npm outdated --json > outdated-report.json || true
          echo "## ğŸ“¦ Outdated Packages Report" >> $GITHUB_STEP_SUMMARY
          
          if [ -s outdated-report.json ] && [ "$(cat outdated-report.json)" != "{}" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Package | Current | Wanted | Latest | Type |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|---------|--------|--------|------|" >> $GITHUB_STEP_SUMMARY
            jq -r 'to_entries[] | "| \(.key) | \(.value.current) | \(.value.wanted) | \(.value.latest) | \(if (.value.wanted != .value.latest) then "âš ï¸ Major" else "âœ… Minor/Patch" end) |"' outdated-report.json >> $GITHUB_STEP_SUMMARY || true
          else
            echo "âœ… All packages are up to date!" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Upload outdated report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: outdated-packages-report
          path: outdated-report.json
          retention-days: 30
  
  test-with-updates:
    name: Test with Latest Compatible Updates
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Backup lock file
        run: cp package-lock.json package-lock.json.backup
      
      - name: Update dependencies (patch only)
        run: |
          npm update --save
          echo "## ğŸ“¦ Updated Packages" >> $GITHUB_STEP_SUMMARY
          git diff package.json >> $GITHUB_STEP_SUMMARY || true
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run TypeScript build
        run: npm run build
      
      - name: Run adapter tests
        run: npm run test:adapter || true
      
      - name: Check for test failures
        id: test-check
        run: |
          if [ $? -ne 0 ]; then
            echo "âš ï¸ Tests failed with updated dependencies" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… All tests passed with updated dependencies" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Create PR with updates
        if: success()
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: 'chore(deps): automated patch updates'
          title: 'chore(deps): Automated Dependency Patch Updates'
          body: |
            ## Automated Dependency Updates
            
            This PR contains automated patch-level dependency updates that have passed all tests.
            
            ### Changes
            - Updated patch versions of dependencies
            - All tests passing
            - TypeScript build successful
            
            ### Testing
            - âœ… TypeScript compilation
            - âœ… Adapter smoke tests
            
            **Auto-generated by dependency management workflow**
          branch: deps/automated-patch-updates
          labels: dependencies, automated, patch-update
          delete-branch: true
      
      - name: Restore lock file on failure
        if: failure()
        run: |
          cp package-lock.json.backup package-lock.json
          echo "âš ï¸ Lock file restored due to test failures" >> $GITHUB_STEP_SUMMARY
  
  dependency-review:
    name: Dependency Review (PRs)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          deny-licenses: GPL-2.0, GPL-3.0
          comment-summary-in-pr: true
  
  update-dependency-dashboard:
    name: Update Dependency Dashboard
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    needs: [audit-security, check-outdated]
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Generate dependency report
        run: |
          npm ci
          
          # Create comprehensive dependency report
          cat > dependency-dashboard.md << 'EOF'
          # Dependency Dashboard
          
          **Last Updated:** $(date -u +"%Y-%m-%d %H:%M UTC")
          
          ## Security Status
          
          EOF
          
          npm audit --json > audit.json || true
          CRITICAL=$(jq '.metadata.vulnerabilities.critical' audit.json)
          HIGH=$(jq '.metadata.vulnerabilities.high' audit.json)
          MODERATE=$(jq '.metadata.vulnerabilities.moderate' audit.json)
          LOW=$(jq '.metadata.vulnerabilities.low' audit.json)
          
          echo "- ğŸ”´ Critical: $CRITICAL" >> dependency-dashboard.md
          echo "- ğŸŸ  High: $HIGH" >> dependency-dashboard.md
          echo "- ğŸŸ¡ Moderate: $MODERATE" >> dependency-dashboard.md
          echo "- ğŸŸ¢ Low: $LOW" >> dependency-dashboard.md
          echo "" >> dependency-dashboard.md
          
          echo "## Outdated Packages" >> dependency-dashboard.md
          echo "" >> dependency-dashboard.md
          
          npm outdated --json > outdated.json || true
          
          if [ -s outdated.json ] && [ "$(cat outdated.json)" != "{}" ]; then
            echo "| Package | Current | Wanted | Latest | Update Type |" >> dependency-dashboard.md
            echo "|---------|---------|--------|--------|-------------|" >> dependency-dashboard.md
            jq -r 'to_entries[] | "| \(.key) | \(.value.current) | \(.value.wanted) | \(.value.latest) | \(if (.value.wanted != .value.latest) then "Major âš ï¸" else "Minor/Patch âœ…" end) |"' outdated.json >> dependency-dashboard.md
          else
            echo "âœ… All packages are up to date!" >> dependency-dashboard.md
          fi
          
          echo "" >> dependency-dashboard.md
          echo "## Recommendations" >> dependency-dashboard.md
          echo "" >> dependency-dashboard.md
          echo "1. Address critical and high severity vulnerabilities immediately" >> dependency-dashboard.md
          echo "2. Review and update major version changes with breaking change analysis" >> dependency-dashboard.md
          echo "3. Group minor and patch updates for efficient testing" >> dependency-dashboard.md
      
      - name: Create or update dashboard issue
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: 'ğŸ“Š Dependency Dashboard - $(date +%Y-%m-%d)'
          content-filepath: dependency-dashboard.md
          labels: dependencies, dashboard, automated
